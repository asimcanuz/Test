use actix_web::{web, App, HttpServer, HttpResponse, Responder, HttpRequest, middleware};
use actix_files::NamedFile; // Zero-copy & Range Requests iÃ§in (For Zero-copy & Range Requests)
use actix_web::http::header::{CACHE_CONTROL, CacheControl, CacheDirective}; // Header modÃ¼lleri
use serde::{Deserialize, Serialize};
use std::env;
use std::path::{Path, PathBuf};
use dotenvy::dotenv;
use jsonwebtoken::{decode, DecodingKey, Validation, Algorithm};
use actix_web_lab::middleware::Compress;
use actix_governor::{Governor, GovernorConfigBuilder};
use std::time::Duration;

// ---------------------------------------------------------
// 1. Veri YapÄ±larÄ± (Data Structures)
// ---------------------------------------------------------

#[derive(Debug, Serialize, Deserialize)]
struct Claims {
    sub: String, // Ä°stenen dosya yolu (Requested file path)
        exp: usize,  // Son kullanma tarihi (Expiration timestamp)
        }

        struct AppState {
            jwt_secret: String,
                base_storage_path: String,
                }

                // ---------------------------------------------------------
                // 2. Handler (Ä°stek KarÅŸÄ±layÄ±cÄ± / Request Handler)
                // ---------------------------------------------------------

                // Health Check Endpoint (SaÄŸlÄ±k KontrolÃ¼) ðŸ¥
                async fn health_check() -> impl Responder {
                    HttpResponse::Ok().json(serde_json::json!({
                        "status": "healthy",
                        "service": "cdn-service"
                    }))
                }

                async fn download_file(req: HttpRequest, data: web::Data<AppState>) -> impl Responder {
                    // A. Token KontrolÃ¼ (Token Check) ðŸ›¡ï¸
                        let auth_header = match req.headers().get("Authorization") {
                                Some(h) => h.to_str().unwrap_or(""),
                                        None => return HttpResponse::Unauthorized().body("Token yok! (No Token!)"),
                                            };

                                                if !auth_header.starts_with("Bearer ") {
                                                        return HttpResponse::Unauthorized().body("Gecersiz Token formati! (Invalid format!)");
                                                            }

                                                                let token_string = &auth_header[7..];
                                                                    let key = DecodingKey::from_secret(data.jwt_secret.as_bytes());
                                                                        // Sadece HS256 algoritmasÄ±nÄ± kabul et (Only accept HS256)
                                                                            let validation = Validation::new(Algorithm::HS256);

                                                                                // Token'Ä± Ã§Ã¶z ve sÃ¼resini kontrol et (Decode token and check expiration)
                                                                                    let file_sub_path = match decode::<Claims>(token_string, &key, &validation) {
                                                                                            Ok(token_data) => token_data.claims.sub,
                                                                                                    Err(_) => return HttpResponse::Unauthorized().body("Token gecersiz veya sÃ¼resi dolmuÅŸ! (Invalid or expired token!)"),
                                                                                                        };

                                                                                                            // B. Yol GÃ¼venliÄŸi (Path Sanitization) ðŸ§¹
                                                                                                                // ".." saldÄ±rÄ±larÄ±nÄ± engelle (Prevent ".." attacks)
                                                                                                                    let base_path = Path::new(&data.base_storage_path);
                                                                                                                        let requested_path = Path::new(&file_sub_path);

                                                                                                                            // Yolu birleÅŸtir ve temizle (Join and canonicalize path)
                                                                                                                                let full_path = match base_path.join(requested_path).canonicalize() {
                                                                                                                                        Ok(path) => path,
                                                                                                                                                Err(_) => return HttpResponse::NotFound().body("Dosya bulunamadÄ±! (File not found!)"),
                                                                                                                                                    };

                                                                                                                                                        // Dosya gerÃ§ekten bizim klasÃ¶rde mi? (Is file really in our folder?)
                                                                                                                                                            if !full_path.starts_with(base_path) {
                                                                                                                                                                    return HttpResponse::Forbidden().body("YasaklÄ± BÃ¶lge! (Access Denied!)");
                                                                                                                                                                        }

                                                                                                                                                                            // C. Dosya GÃ¶nderimi (File Serving) ðŸš€
                                                                                                                                                                                // 'open_async' thread'i bloklamaz (Does not block thread)
                                                                                                                                                                                    let named_file = match NamedFile::open_async(&full_path).await {
                                                                                                                                                                                            Ok(file) => file,
                                                                                                                                                                                                    Err(_) => return HttpResponse::NotFound().body("Dosya diskte yok! (File missing on disk!)"),
                                                                                                                                                                                                        };

                                                                                                                                                                                                            // D. AkÄ±llÄ± Caching (Smart Caching) ðŸ§ 
                                                                                                                                                                                                                let extension = full_path.extension().and_then(|e| e.to_str()).unwrap_or("");
                                                                                                                                                                                                                    let mut response = named_file.into_response(&req);

                                                                                                                                                                                                                        if ["jpg", "jpeg", "png", "webp", "gif", "mp4"].contains(&extension) {
                                                                                                                                                                                                                                // Medya dosyalarÄ±: 1 YÄ±l Cache (Media files: 1 Year Cache)
                                                                                                                                                                                                                                        response.headers_mut().insert(
                                                                                                                                                                                                                                                    CACHE_CONTROL, 
                                                                                                                                                                                                                                                                "public, max-age=31536000, immutable".parse().unwrap()
                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                            } else {
                                                                                                                                                                                                                                                                                    // DokÃ¼manlar: Cache yok (Docs: No Cache)
                                                                                                                                                                                                                                                                                            response.headers_mut().insert(
                                                                                                                                                                                                                                                                                                        CACHE_CONTROL, 
                                                                                                                                                                                                                                                                                                                    "private, no-cache".parse().unwrap()
                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                    response
                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                    // ---------------------------------------------------------
                                                                                                                                                                                                                                                                                                                                    // 3. Main (GiriÅŸ / Entry)
                                                                                                                                                                                                                                                                                                                                    // ---------------------------------------------------------

                                                                                                                                                                                                                                                                                                                                    #[actix_web::main]
                                                                                                                                                                                                                                                                                                                                    async fn main() -> std::io::Result<()> {
                                                                                                                                                                                                                                                                                                                                        dotenv().ok();
                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                // Fail-Fast: Ayarlar yoksa baÅŸlatma (Don't start if config missing)
                                                                                                                                                                                                                                                                                                                                                    let secret = env::var("JWT_SECRET").expect("JWT_SECRET .env dosyasÄ±nda eksik!");
                                                                                                                                                                                                                                                                                                                                                        let storage_path = env::var("STORAGE_PATH").unwrap_or_else(|_| "./uploads".to_string());

                                                                                                                                                                                                                                                                                                                                                            let state = web::Data::new(AppState {
                                                                                                                                                                                                                                                                                                                                                                    jwt_secret: secret,
                                                                                                                                                                                                                                                                                                                                                                            base_storage_path: storage_path,
                                                                                                                                                                                                                                                                                                                                                                                });

                                                                                                                                                                                                                                                                                                                                                                                    println!("ðŸš€ CDN Servisi BaÅŸlatÄ±ldÄ± (Port: 8080)");
                                                                                                                                                                                                                                                                                                                                                                                        println!("ðŸ“‚ Depolama Yolu: {}", state.base_storage_path);

                                                                                                                                                                                                                                                                                                                                                                                            HttpServer::new(move || {
                                                                                                                                                                                                                                                                                                                                                                                                    App::new()
                                                                                                                                                                                                                                                                                                                                                                                                                .app_data(state.clone())
                                                                                                                                                                                                                                                                                                                                                                                                                            .route("/download", web::get().to(download_file))
                                                                                                                                                                                                                                                                                                                                                                                                                                })
                                                                                                                                                                                                                                                                                                                                                                                                                                    .bind(("0.0.0.0", 8080))? // 0.0.0.0 Docker iÃ§in gereklidir (Required for Docker)
                                                                                                                                                                                                                                                                                                                                                                                                                                        .run()
                                                                                                                                                                                                                                                                                                                                                                                                                                            .await
                                                                                                                                                                                                                                                                                                                                                                                                                                            }